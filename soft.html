<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Sofmoプログラム</title>

        <link href="css/bootstrap.css" rel="stylesheet">
        <script src="js/SofmoFsk.js" type="text/javascript"></script>
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
        <script type="text/javascript">
            function $(name) {
                return document.getElementById(name);
            }
            function chr8() {
                return Array.prototype.map.call(arguments, function (a) {
                    return String.fromCharCode(a & 0xff)
                }).join('');
            }
            function chr16() {
                return Array.prototype.map.call(arguments, function (a) {
                    return String.fromCharCode(a & 0xff, (a >> 8) & 0xff)
                }).join('');
            }
            function chr32() {
                return Array.prototype.map.call(arguments, function (a) {
                    return String.fromCharCode(a & 0xff, (a >> 8) & 0xff, (a >> 16) & 0xff, (a >> 24) & 0xff);
                }).join('');
            }
            function toUTF8(str) {
                var utf8 = [];
                for (var i = 0; i < str.length; i++) {
                    var c = str.charCodeAt(i);
                    if (c <= 0x7f)
                        utf8.push(c);
                    else if (c <= 0x7ff) {
                        utf8.push(0xc0 | (c >>> 6));
                        utf8.push(0x80 | (c & 0x3f));
                    } else if (c <= 0xffff) {
                        utf8.push(0xe0 | (c >>> 12));
                        utf8.push(0x80 | ((c >>> 6) & 0x3f));
                        utf8.push(0x80 | (c & 0x3f));
                    } else {
                        var j = 4;
                        while (c >>> (6 * j))
                            j++;
                        utf8.push(((0xff00 >>> j) & 0xff) | (c >>> (6 * --j)));
                        while (j--)
                            utf8[idx++] = 0x80 | ((c >>> (6 * j)) & 0x3f);
                    }
                }
                return utf8;
            }


            var dataURI, audio;
            function generate(str) {
                if (str.length == 0)
                    return;
                var utf8 = toUTF8(str);
                //console.log(utf8);

                var sampleRate = 29400;
                var baud = 1225;
                var freqHigh = 7350;
                var freqLow = 4900;
                var spb = sampleRate / baud; // 24 samples per bit
                var preCarrierBits = Math.ceil(sampleRate * 40 / 1000 / spb); // 49 bits
                var postCarrierBits = Math.ceil(sampleRate * 5 / 1000 / spb); // 6.125 bits => 7 bits
                var size = (preCarrierBits + postCarrierBits + 10 * utf8.length) * spb;

                var data = "RIFF" + chr32(size + 36) + "WAVE" +
                        "fmt " + chr32(16, 0x00010001, sampleRate, sampleRate, 0x00080001) +
                        "data" + chr32(size);

                function pushData(freq, samples) {
                    for (var i = 0; i < samples; i++) {
                        var v = 128 + 127 * Math.sin((2 * Math.PI) * (i / sampleRate) * freq);
                        data += chr8(v);
                    }
                }
                pushData(freqHigh, preCarrierBits * spb);
                for (var x in utf8) {
                    var c = (utf8[x] << 1) | 0x200;
                    for (var i = 0; i < 10; i++, c >>>= 1)
                        pushData((c & 1) ? freqHigh : freqLow, spb);
                }
                pushData(freqHigh, postCarrierBits * spb);

                if (size + 44 != data.length)
                    alert("wrong size: " + size + 44 + " != " + data.length);

                dataURI = "data:audio/wav;base64," + escape(btoa(data));
                audio = new Audio(dataURI);
                audio.play();

                $('jmp').disabled = false;
            }
        </script>

    </head>
    <body>


        <div class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a href="index.html" class="navbar-brand">Sofmo</a>
                    <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="navbar-collapse collapse" id="navbar-main">
                    <ul class="nav navbar-nav">
                        <li>
                            <a href="soft.html">プログラム</a>
                        </li>
                        <li>
                            <a href="hard.html">Sofmoハードウェア</a>
                        </li>
                        <li>
                            <a href="index.html">作品ライブラリ(準備中)</a>
                        </li>
                    </ul>
                </div>

            </div>
        </div>

        <div class="container">

            <div class="page-header" id="banner">
                <div class="row">
                    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-8">
                        <h1>Sofmo</h1> 
                        <p class="lead">Sofmoとは音で通信するarduino互換</p>     
                    </div>
                </div>
            </div>

            <div class="page-header">
                <div class="row">
                    <div class="col-lg-12">
                        <h2 id="buttons">Sofmoのプログラム</h2>
                    </div>
                </div>         
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <h2 id="buttons">Sofmo</h2>
                    <H4>Sofmoのlibraryは、こちらから<a href="data/SoftModem-001.zip">ダウンロード</a></H4>
                    <p>注意</p>
                    <p>Sofmoの機能であるイヤホンジャック通信を利用する際、D3、D6、D7ピンを使用します。プログラムする際は注意してください。</p>                        
                    <h2 id="buttons">Android</h2>
                    <!-- Place this tag in your head or just before your close body tag. -->
                    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
                    <!-- Place this tag where you want the widget to render. -->
                    <div class="g-post" data-href="https://plus.google.com/108903233619967417797/posts/BTkkAgvPgbZ"></div>
                    <h2 id="buttons">Web(javascript)</h2>
                    <br><p>Sofmoの通信をjavascriptで実現しました。NeoCatさんの作品です。</p>
                    <form onsubmit="generate($('data').value);
                return false;">
                        入力してみてください: <input type="text" id="data" size="40" value="Hello!">
                        <input type="submit" value="Generate and Send" >
                        <input type="button" value="Jump to Audio data" id="jmp" disabled="true" onclick="location.href = dataURI">
                    </form>

                </div>
            </div>         


            <div class="page-header">
                <div class="row">
                    <div class="col-lg-12">
                        <h2 id="buttons">Sofmoのスケッチアップロードについて</h2>
                    </div>
                </div>              
            </div>
            <div class="col-lg-12">
                <p>Windowsの場合は<a href="http://www.arduino.cc/en/Main/Software">ArduinoIDE</a>をインストールしたのちArduinoProを選ぶか、</p>
                <p>こちらの<a href="data/64or32bit.zip">バッチファイル</a>を実行してもらえば、ツールの中のボードにSofmoが追加されるのでそれを選んで書き込んでもらうこともできます！</p>
                <div class="row">
                    <figure>
                        <legend>Arduino Pro 328(3.3v,8MHz)で試すとき</legend>
                        <img src="pic/ArdP.jpg" alt="" class="col-lg-8 col-md-7 col-sm-6 col-xs-8"/>
                        <br>
                    </figure>
                    <figure>
                        <legend>Batファイルを実行してから、Sofmoで試すとき</legend>
                        <img src="pic/SofA.jpg" alt="" class="col-lg-8 col-md-7 col-sm-6 col-xs-8"/>
                    </figure>
                </div>
                <br>
                <p>Sofmoのusbシールドはfl232rを使っています。ドライバーをダウンロードしてください。</p>
                <p>追加でUSB aをつけた方はこちらのアプリを使うとAndroidからプログラムを書くことができます。</p>
                <a href="https://play.google.com/store/apps/details?id=com.physicaloid.app.writer">https://play.google.com/store/apps/details?id=com.physicaloid.app.writer</a>
            </div>

        </div>
        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r;
                i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
                a = s.createElement(o),
                        m = s.getElementsByTagName(o)[0];
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-62256925-1', 'auto');
            ga('send', 'pageview');

        </script>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="js/bootstrap.min.js"></script>
    </body>
</html>